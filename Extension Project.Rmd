---
title: "Extension of Villarreal Paper"
author: "Reisman and Lajous"
date: "April 23, 2015"
output: html_document
---

We chose to replicate Andr√©s Villarreal's 2004 AJS paper, "The Social Ecology of Rural Violence: Land Scarcity, the Organization of Agricultural Production, and the Presence of the State." Applying an ecological theory of crime to the study of rural violence in Mexico, Villarreal attempts explain the fact that rural municipalities have high variation in homicide rates by investigating the effects of land distribution, collective ownership, and the organization of agricultural production on homicide rates. He tests five specific hypotheses: (1) When agricultural land is scarce relative to the number of individuals, there will be more conflict and therefore more homicides; (2) An unequal distribution of land will lead to more violent conflict; (3) When property rights are not well enforced or are contingent, there will be more conflict over lands. For this reason, ejido and communal units will experience more violence; (4) agricultural production systems that involve more commodified relations of production and exchange will be associated with a breakdown of community social cohesion and therefore with more violence, and the introduction of cash crops will lead to greater conflict over resources and control over trade, and consequently to more violence; and (5) remote mountainous areas will have higher rates of violence due to the absence of state institutions.

We were unable to replicate Villarreal's findings, due in part to changes in Mexican data disclosure laws. For our extension of Villarreal's paper, we decided to update his analysis with newer (2007) data -- his original analysis was conducted using 1991 data. In doing so, we decided to remove the variables for which we identified data issues (The Thiel Index, Percent of Plots 5 Hectares or Less, and Log of Average Plot Size), as well as one variable for which 2007 data is not available (Percent Subsistence Agriculture). We correspondingly decided to include several new variables in the analysis, including a different indicator of land inequality to replace the Thiel index (the Gini Index), new indicators of state presence not used by Villarreal (Number of Policemen per 100,000 people, Property Taxes per Capita) and a new control variable -- the Human Development Index (HDI). We hope that these changes and additions will produce a valid analysis that we can compare to Villrreal's findings.


```{r, warning=FALSE, error=FALSE}
library(ggplot2)
library(dplyr)
library(xlsx)
library(zoo)
library(foreign)
library(tidyr)
library(gdata)
library(maptools)
library(gpclib) 
library(RColorBrewer)
library(scales)
library(SDMTools)
```

```{r, warning=FALSE, error=FALSE}

# poverty and inequality (2010) --------------------------------------------------


##load CONEVAL poverty and inequality database
coneval <- read_csv("data/3.3 Concentrado, indicadores de pobreza por municipio.csv", skip = 6, col_names = FALSE)


##create table with muncode and percent in poverty, in extreme poverty and gini index 
poor <- coneval %>%
  filter(!is.na(X3)) %>%
  select(muncode = X3, pct.poor = X6, 
         pct.extpoor = X10, gini = X45) 


# Human development index (2010, per capita GNP, schooling, health) ------------

HDI <- read_csv("data/HDI_2010_UNDP.csv", skip = 3, 
                col_names = c("state", "mun", "Entidad",  "Municipio",  "school.level",
                              "expected.school",	"GNP.pc", 	"child.mort",	"education.index",
                              "income.index", 	"health.index",	"HDI"))
HDI <- HDI %>%
  mutate(muncode = state*1000 + mun) %>%
  select(muncode, HDI)


# doctors per 1000 pop ----------------------------------------------------

doctors <- read_csv("data/doctors_2005_2010.csv", skip = 2, n_max = 2456)

doctors <- doctors %>%
  select(muncode = Clave, docs = `2010`)

# police per 1000 pop -----------------------------------------------------

police <- read_csv("data/police_2010.csv", skip = 2, n_max = 2462, 
                   col_names = c("muncode", "state", "mun", "total.pers", "pol100k", "pol1k"))

police <- police %>%
  select(muncode, pol1k) %>%
  mutate(pol1k = ifelse(pol1k == "n. d.", NA, pol1k))

# homicides 2006, 2007, 2008 ----------------------------------------------

homicides <- read_csv(file="data/homicide_1990_2013_INEGI.csv", col_names = FALSE, skip = 6)

## new coloumn names, default were unreadable
colnames(homicides) <- c("muncode", "name", 2013:1990)
homicides[is.na(homicides)] <- 0

##clean out NAs and others, 
homicides <- homicides %>%
  filter(!grepl("996|997|998|991|993|992", muncode), muncode > 1000) %>%
  select(muncode, name, `2008`:`2006`)

```

**CONVERTING AND CALCULATING DATA FOR OAXACA**

```{r}
#oaxaca distritos 2010 --------------------------------------------------

oaxaca.distritos <- read.xlsx("data/oaxaca_distritos_2010.xls", 3, 
                              startRow = 6, endRow = 685, encoding = "latin1")
oaxaca.distritos <- tbl_df(oaxaca.distritos) 

#create table with municipality codes 
distritos <- oaxaca.distritos  %>%
  select(mun = Clave) %>%
  filter(!is.na(mun)) %>%
  mutate(mun = as.numeric(as.character(mun)), 
         muncode = (mun + 20000))

#create column that assigns districts to each muncode
distritos$distrito = rep(NA, nrow(distritos))
distritos$distrito[is.na(distritos$mun)] <- c(1:30)
distritos$distrito <- na.locf(distritos$distrito)

#filter out NA rows with district names
distritos <- distritos %>%
  filter(!is.na(mun))
```

```{r, warning=FALSE, echo=FALSE}
#join district table with oaxaca population table by district and generate new muncodes with district number. filter out new municipalies(districts) with more than 75% of population living in towns of less than 2500. 
#NEED TO UPDATE THIS
df.oax$pop.less.2500[is.na(df.oax$pop.less.2500)] <- 0

oaxaca.d <- left_join(distritos, df.oax, by = "muncode") 
oaxaca.d <-filter(oaxaca.d, !(is.na(name))

#prepping code for oaxaca data
oaxaca.d <- oaxaca.d  %>% #NEED TO ADD NEW VARIABLES
  group_by(distrito) %>% 
  summarise(pop.less.2500 = sum(pop.less.2500), total.pop = sum(total.pop), prop.less.2500 = pop.less.2500/total.pop,
            indi = sum(indi), pct.indi = (indi/total.pop) * 100, 
            no.literacy = sum(no.literacy), no.lit.rate = (no.literacy/total.pop) * 100,
            sqkm = sum(sqkm), log.pop.dens = log10(total.pop/sqkm), 
            doctors = sum(doctors), docs.per.10k = (doctors/total.pop)*10000, 
            fem.house = sum(fem.house), total.house = sum(total.house), pct.fem.house = (fem.house/total.house) * 100,
            young.total = sum(young.total), pct.young = (young.total/total.pop) * 100, 
            hom.total = sum(hom.total), hom.rate = hom.total/(total.pop*3)*100000,
            ejidal = sum(ejidal), total_area = sum(total_area), log.pop.surface = log10(total.pop/total_area), 
            pct.ej = (ejidal/total_area) * 100,
            comunal = sum(comunal), pct.com = (comunal/total_area) * 100,
            private = sum(private), pct.individual = (private/total_area) * 100,
            total.cattle.units = sum(total.cattle.units), total_prod_units = sum(total_prod_units), pct.cattle = (total.cattle.units/total_prod_units) * 100,
            corn.tons = sum(corn.tons), corn.ha = sum(corn.ha), log.corn.yield = log10(corn.tons/corn.ha),
            total.coffee.units = sum(total.coffee.units), pct.coffee = (total.coffee.units/total_prod_units) * 100) %>%
  select(-no.literacy, -indi, -pop.less.2500, -doctors, -fem.house, -total.house, -young.total, -sqkm, -hom.total, -ejidal, -total_area, -comunal, -private, -total_prod_units, -corn.tons, -total.cattle.units, -corn.tons, -corn.ha) %>%
  mutate(muncode = distrito + 20000)

oaxaca.dist$pct.coffee[is.na(oaxaca.dist$pct.coffee)] <- 0
```

**Adding Weighted Variables for Oaxaca**

```{r, warning=FALSE, error=FALSE}

##UPDATE/TAILOR THIS
## SD ELEVATION WEIGHTED BY POPULATION FOR OAXACA

## join population and elevation data frame with distritos in oaxaca 
pop_elev.dis <- left_join(pop_elev.oax, distritos, by = "muncode")

## calculate sd elevation weighted by population grouped by distrito, and a dummy variable for the state of mexico
weigh_elev.oax <- pop_elev.dis %>% 
  group_by(distrito) %>% 
  summarise(weigh.elev = wt.sd(elev, total.pop)) %>% # use SDMTools to calculate weighted sd
  mutate(muncode = 20000 + distrito, dummy.SOM = 0) %>%
  select(-distrito)

## join weighted elevation with oaxaca main data frame
oaxaca.dist <- left_join(oaxaca.d, weigh_elev.oax, by = "muncode")

#calculate weighted SD of elevation for map
elev.map.oax <- left_join(distritos, elev.oax, by = "muncode") %>%
  group_by(distrito) %>%
  weigh.elev = wt.sd(elev, total.pop)) %>% 
  select(muncode, weigh.elev)

elev.map.oax <- elev.map.oax[!duplicated(elev.map.oax), ]

#GINI INDEX
#calculate population weighted average Gini index for Oaxacan municipalities
pop_gini <- left_join(#CENSUS WITH TOTAL POP, poor, by = "muncode")
pop_gini.dis <- left_join(pop_gini, distritos, by = "muncode")

weigh_gini.oax <- pop_gini.dis %>%
  group_by(distrito) %>%
  summarise(weigh.gini = wt.mean(gini, total.pop)) %>%
  mutate(muncode = 20000 + distrito) %>%
  select(-distrito)

#join with main oaxaca dataframe
oaxaca.d <- left_join(oaxaca.d, weigh_gini.oax, by = "muncode")

#HDI
#calculate population weighted average HDI for Oaxacan municipalities
pop_hdi <- left_join(#CENSUS WITH TOTAL POP, HDI, by = "muncode")
pop_hdi.dis <- left_join(pop_hdi, distritos, by = "muncode")

weigh_hdi.oax <- pop_hdi.dis %>%
  group_by(distrito) %>%
  summarise(weigh.hdi = wt.mean(HDI, total.pop)) %>%
  mutate(muncode = 20000 + distrito) %>%
  select(-distrito)

#join with main oaxaca dataframe
oaxaca.d <- left_join(oaxaca.d, weigh_hdi.oax, by = "muncode")

#select variables for dataframe used in map for Oaxaca
oax.for.map <- select(oaxaca.d, muncode, hom.rate, sd.elev) #IS THE FACT THAT THIS IS NOT THE WEIGHED SD OF ELEVATION THE REASON IT DOESNT LOOK QUITE THE SAME?

#filter to oaxaca sample 
sample.oax <- oaxaca.d %>%  
  filter(prop.less.2500 > .75) 

```

